# Архитектура компилятора и рантайма

## 1. Pipeline

`source(.яс)` -> `lexer` -> `parser(AST)` -> `module resolver` -> `type checker` -> `optimizer` -> `bytecode` -> `VM`

Команда `yasn run` проходит весь pipeline за один запуск.

## 2. Ключевые модули

- `yasny/lexer.py` — токенизация, `NEWLINE/INDENT/DEDENT`, запрет TAB
- `yasny/parser.py` — AST и приоритетный разбор выражений
- `yasny/module_loader.py` — модульная линковка, импорты, экспорты, алиасы, пути, цикл-детект
- `yasny/checker.py` — статическая типизация, области видимости, сигнатуры функций
- `yasny/optimizer.py` — constant folding, удаление мертвого кода, упрощение веток
- `yasny/compiler.py` — генерация стекового байткода
- `yasny/bc.py` — сериализация/десериализация `.ybc`
- `yasny/vm.py` — интерпретация байткода
- `yasny/server.py` — встроенный HTTP backend (`yasn serve`)
- `yasny/project_runner.py` — режимы `yasn run dev` / `yasn start`
- `yasny/app_bundle.py` — упаковка `.yapp`, установка приложений
- `yasny/cli.py` — интерфейс командной строки

## 3. Лексер и парсер

Лексер работает с UTF-8 и формирует токены для русскоязычных ключевых слов.

Парсер (recursive descent) строит AST и поддерживает:

- объявления `пусть`, `функция`
- `если/иначе`, `пока`, `для`
- `прервать`, `продолжить`
- модульный синтаксис `подключить`, `из ... подключить`, `как`
- типы `Список/Словарь`, объединения `|`, nullable `?`
- выражения с вызовами, индексацией и namespace-доступом `a.b`

## 4. Разрешение модулей

`ModuleResolver` выполняет линковку до типизации.

Что делает резолвер:

1. Находит проектный контекст (`yasn.toml`, fallback: `yasny.toml`, затем корень с `pyproject.toml`)
2. Разрешает пути модулей
3. Загружает AST зависимостей
4. Проверяет циклические импорты
5. Материализует импортированные объявления под внутренними уникальными именами
6. Переписывает ссылки в коде (`alias`/`namespace`) до плоской программы

### 4.1 Экспорты

- Если в модуле нет `экспорт`, включается режим совместимости: экспортируются верхнеуровневые `пусть/функция` кроме `main`
- Если есть хотя бы один `экспорт`, наружу доступны только явно помеченные объявления

### 4.2 `yasn.toml`

```toml
[modules]
root = "examples"
paths = ["examples/lib"]
```

Используется при разрешении импортов после относительного пути текущего файла.

## 5. Типизатор

`TypeChecker` проверяет программу до компиляции.

Основные проверки:

- объявление переменных до использования
- совместимость присваивания
- корректные типы операторов
- корректность `return`
- `если/пока` требуют `Лог`
- `для` итерирует `Список[Т]`
- `break/continue` только внутри циклов
- индексация для `Список`, `Словарь`, `Строка`
- сигнатура `main`: без параметров, `-> Пусто`

## 6. Оптимизатор

`optimizer.py` выполняет безопасные локальные оптимизации AST:

- свертка констант в выражениях
- удаление кода после `вернуть/прервать/продолжить`
- упрощение `если` с константным условием
- удаление `пока ложь`
- удаление неиспользуемых функций (tree shaking от корней: top-level вызовы и `main`)

## 7. Байткод

VM стековая. Инструкции работают с локальными и глобальными слотами.

Группы инструкций:

- константы и переменные: `CONST`, `CONST_NULL`, `LOAD`, `STORE`, `GLOAD`, `GSTORE`, `POP`
- арифметика/логика: `ADD`, `SUB`, `MUL`, `DIV`, `MOD`, `NEG`, `NOT`, `EQ`, `NE`, `LT`, `LE`, `GT`, `GE`
- управление потоком: `JMP`, `JMP_FALSE`
- вызовы: `CALL`, `RET`, `HALT`
- коллекции: `MAKE_LIST`, `MAKE_DICT`, `INDEX_GET`, `INDEX_SET`, `LEN`

`ProgramBC` содержит:

- `functions`
- `entry`
- `global_count`

## 8. Формат `.ybc`

Структура:

1. `MAGIC` = `YASNYBC1`
2. `LEN` (`u32 LE`)
3. JSON payload

Payload включает таблицу функций, entry-функцию и `global_count`.

## 9. VM

`VirtualMachine`:

- хранит стек значений
- создает frame на каждый `CALL`
- хранит общий массив глобальных слотов
- выполняет builtins: `печать`, `длина`, `диапазон`, `ввод`

При `run`:

1. Инициализируются глобальные слоты
2. Выполняется `entry`
3. Если в байткоде есть вызов `main`, она запускается после top-level кода

## 10. Контейнер `.yapp`

`app_bundle.py` упаковывает байткод в контейнер с метаданными (`name`, `version`) и поддерживает установку пользовательских приложений как команд через `.cmd` launcher.

Пользовательские каталоги:

- `%APPDATA%\yasn\apps`
- `%APPDATA%\yasn\bin`

## 11. Границы текущей реализации

- Нет native-code backend (только VM)
- Нет пользовательских типов (классы/структуры)
- Нет исключений и модульной системы пакетов с версиями
- Нет встроенного тестового раннера
