name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-installer:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Publish yasn
        run: |
          dotnet publish native/yasn-native/yasn-native.csproj `
            -c Release -r win-x64 --self-contained true `
            /p:PublishSingleFile=true /p:PublishTrimmed=false

      - name: Set version from tag
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          (Get-Content installer/yasn.iss) -replace 'MyAppVersion "[\d.]+"', "MyAppVersion `"$version`"" | Set-Content installer/yasn.iss

      - name: Prepare staging
        run: |
          New-Item -ItemType Directory -Force -Path installer/staging/bin | Out-Null
          New-Item -ItemType Directory -Force -Path installer/staging/packages | Out-Null
          Copy-Item native/yasn-native/bin/Release/net10.0/win-x64/publish/yasn.exe installer/staging/bin/
          if (!(Test-Path packages/ui-sdk)) { throw "Source directory packages/ui-sdk not found" }
          if (!(Test-Path packages/ui-kit)) { throw "Source directory packages/ui-kit not found" }
          robocopy packages/ui-sdk installer/staging/packages/ui-sdk /E /XD node_modules /NFL /NDL /NJH /NJS /nc /ns /np
          $robocopyExit = $LASTEXITCODE
          echo "robocopy exit code: $robocopyExit"
          if ($robocopyExit -ge 8) { exit $robocopyExit }
          $global:LASTEXITCODE = 0
          robocopy packages/ui-kit installer/staging/packages/ui-kit /E /XD node_modules /NFL /NDL /NJH /NJS /nc /ns /np
          $robocopyExit = $LASTEXITCODE
          echo "robocopy exit code: $robocopyExit"
          if ($robocopyExit -ge 8) { exit $robocopyExit }
          $global:LASTEXITCODE = 0

      - name: Compile Inno Setup
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/yasn.iss

      - name: Verify installer output
        id: installer
        shell: pwsh
        run: |
          $files = Get-ChildItem -Path installer/dist -Filter "Yasn-Setup-*.exe" -File -ErrorAction SilentlyContinue
          if (-not $files) {
            Write-Error "Installer output not found in installer/dist (pattern: Yasn-Setup-*.exe)."
            if (Test-Path installer/dist) {
              Get-ChildItem installer/dist -Force | Format-Table -AutoSize | Out-String | Write-Host
            } else {
              Write-Host "Directory installer/dist does not exist."
            }
            exit 1
          }
          $assetPath = $files[0].FullName
          Write-Host "Release asset: $assetPath"
          "asset_path=$assetPath" >> $env:GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.installer.outputs.asset_path }}
          fail_on_unmatched_files: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
